---
id: "006"
title: "Flutter基础框架搭建"
epic: "外卖app"
status: "backlog"
assigned: ""
labels: ["flutter", "framework", "setup"]
priority: "high"
effort: "M"  # 12 hours
dependencies: []
parallel: true
created: "2025-12-31T13:44:17Z"
updated: "2025-12-31T13:44:17Z"
---

# 任务006: Flutter基础框架搭建

## 目标
搭建Flutter移动端项目基础架构,包括项目初始化、路由系统、状态管理、网络层、本地存储和主题配置,为后续功能开发提供坚实基础。

## 背景
Flutter移动端需要与后端API并行开发,采用Mock数据先行策略,确保前端开发不依赖后端API完成。使用Material Design 3设计语言,提供现代化UI体验。

## 详细任务

### 1. 项目初始化 (2h)
**技术要求**
- 创建Flutter 3.19+项目(`flutter create food_delivery_app`)
- 配置Android/iOS双平台支持
- 设置应用包名(`com.company.fooddelivery`)
- 配置应用图标和启动页
- 设置应用名称和版本号

**验收标准**
- [ ] 项目可以在Android和iOS模拟器上运行
- [ ] 应用图标和启动页显示正常
- [ ] 包名和版本配置正确

### 2. 路由系统搭建 (2h)
**技术要求**
- 使用Material Design 3导航器
- 实现命名路由配置(`routes.dart`)
- 路由守卫(未登录跳转登录页)
- 页面转场动画配置
- 支持深链接(可选)

**关键路由**
```dart
// 路由常量定义
class Routes {
  static const String splash = '/splash';
  static const String login = '/login';
  static const String home = '/home';
  static const String products = '/products';
  static const String productDetail = '/product/:id';
  static const String cart = '/cart';
  static const String order = '/order';
  static const String orderDetail = '/order/:id';
  static const String profile = '/profile';
}
```

**验收标准**
- [ ] 所有基础路由配置完成
- [ ] 未登录自动跳转登录页
- [ ] 页面转场动画流畅

### 3. Provider状态管理架构 (3h)
**技术要求**
- 集成`provider`状态管理库
- 设计全局状态Provider树
- 实现用户状态管理(`UserProvider`)
- 实现购物车状态管理(`CartProvider`)
- 实现主题状态管理(`ThemeProvider`)

**核心Provider**
```dart
// 用户状态Provider
class UserProvider extends ChangeNotifier {
  User? _user;
  String? _token;

  User? get user => _user;
  bool get isAuthenticated => _token != null;

  Future<void> login(String phone, String code) async;
  Future<void> logout() async;
}

// 购物车Provider
class CartProvider extends ChangeNotifier {
  List<CartItem> _items = [];

  List<CartItem> get items => _items;
  double get totalAmount => _items.fold(0, (sum, item) => sum + item.subtotal);

  void addItem(Product product, int quantity);
  void removeItem(String productId);
  void updateQuantity(String productId, int quantity);
  void clear();
}
```

**验收标准**
- [ ] Provider树结构搭建完成
- [ ] 用户状态持久化(Hive/SharedPreferences)
- [ ] 购物车状态实时更新UI

### 4. Dio网络层封装 (3h)
**技术要求**
- 集成`dio`网络库
- 封装API客户端类(`ApiClient`)
- 实现请求/响应拦截器
- JWT Token自动注入
- 统一错误处理
- 请求日志(DEBUG模式)

**核心实现**
```dart
class ApiClient {
  late Dio _dio;
  String? _token;

  ApiClient() {
    _dio = Dio(BaseOptions(
      baseUrl: 'https://api.example.com',
      connectTimeout: Duration(seconds: 10),
      receiveTimeout: Duration(seconds: 10),
    ));

    _setupInterceptors();
  }

  void _setupInterceptors() {
    _dio.interceptors.add(InterceptorsWrapper(
      onRequest: (options, handler) {
        if (_token != null) {
          options.headers['Authorization'] = 'Bearer $_token';
        }
        return handler.next(options);
      },
      onResponse: (response, handler) {
        return handler.next(response);
      },
      onError: (error, handler) {
        // 统一错误处理
        if (error.response?.statusCode == 401) {
          // Token过期,跳转登录
        }
        return handler.next(error);
      },
    ));
  }

  Future<Response> get(String path, {Map<String, dynamic>? queryParameters});
  Future<Response> post(String path, {dynamic data});
  // ...其他HTTP方法
}
```

**验收标准**
- [ ] Dio配置正确,支持GET/POST/PUT/DELETE
- [ ] Token自动注入到请求头
- [ ] 401错误自动跳转登录页
- [ ] 网络错误友好提示

### 5. Hive本地存储集成 (1h)
**技术要求**
- 集成`hive`和`hive_flutter`库
- 初始化Hive(在main函数中)
- 封装本地存储服务(`StorageService`)
- 持久化用户Token
- 持久化用户信息
- 持久化购物车数据

**核心实现**
```dart
class StorageService {
  static const String _tokenKey = 'auth_token';
  static const String _userKey = 'user_info';
  static const String _cartKey = 'cart_items';

  Future<void> init() async {
    await Hive.initFlutter();
  }

  // Token管理
  Future<void> saveToken(String token) async {
    await Hive.box(_tokenKey).put('token', token);
  }

  String? getToken() {
    return Hive.box(_tokenKey).get('token');
  }

  Future<void> removeToken() async {
    await Hive.box(_tokenKey).delete('token');
  }

  // 用户信息管理
  Future<void> saveUser(User user) async;
  User? getUser();

  // 购物车管理
  Future<void> saveCart(List<CartItem> items) async;
  List<CartItem> getCart();
}
```

**验收标准**
- [ ] Hive初始化成功
- [ ] Token持久化正常
- [ ] 应用重启后用户状态保持

### 6. 主题配置 (1h)
**技术要求**
- 实Material Design 3主题
- 配置浅色/深色模式
- 定义品牌色彩规范
- 配置字体(TextTheme)
- 配置组件圆角、阴影

**主题配置**
```dart
class AppTheme {
  static ThemeData get lightTheme {
    return ThemeData(
      useMaterial3: true,
      colorScheme: ColorScheme.fromSeed(
        seedColor: Colors.orange, // 品牌主色
        brightness: Brightness.light,
      ),
      appBarTheme: AppBarTheme(
        centerTitle: true,
        elevation: 0,
      ),
      cardTheme: CardTheme(
        elevation: 2,
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(12),
        ),
      ),
      // ...更多组件主题
    );
  }

  static ThemeData get darkTheme {
    return ThemeData(
      useMaterial3: true,
      colorScheme: ColorScheme.fromSeed(
        seedColor: Colors.orange,
        brightness: Brightness.dark,
      ),
      // ...深色模式配置
    );
  }
}
```

**验收标准**
- [ ] 浅色/深色模式切换正常
- [ ] 所有组件使用Material Design 3风格
- [ ] 品牌色统一应用

### 7. Mock数据服务 (可选,2h)
**技术要求**
- 创建Mock数据服务(`MockApiService`)
- 模拟商品列表数据(从Material文件夹读取)
- 模拟分类数据
- 模拟用户登录(固定验证码1234)
- 模拟订单创建

**Mock数据示例**
```dart
class MockApiService {
  static const String _verificationCode = '1234';

  // 模拟登录
  Future<User> login(String phone, String code) async {
    await Future.delayed(Duration(seconds: 1)); // 模拟网络延迟

    if (code != _verificationCode) {
      throw Exception('验证码错误');
    }

    return User(
      id: '1',
      phone: phone,
      nickname: '测试用户',
      avatar: 'https://example.com/avatar.png',
    );
  }

  // 模拟商品列表
  Future<List<Product>> getProducts({
    String? categoryId,
    String? keyword,
    int page = 1,
    int pageSize = 20,
  }) async {
    await Future.delayed(Duration(milliseconds: 500));

    // 返回Mock商品数据
    return [
      Product(
        id: '1',
        name: '宫保鸡丁',
        price: 28.00,
        description: '经典川菜',
        imageUrl: '/static/宫保鸡丁.png',
        categoryId: '1',
      ),
      // ...更多商品
    ];
  }

  // ...其他Mock接口
}
```

**验收标准**
- [ ] Mock数据可独立运行,不依赖后端
- [ ] 支持商品列表、登录等核心接口
- [ ] 数据结构与后端API一致

## 技术栈
- **Flutter**: 3.19+
- **Dart**: 3.0+
- **状态管理**: Provider ^6.1.0
- **网络请求**: Dio ^5.4.0
- **本地存储**: Hive ^2.2.3
- **路由**: go_router ^13.0.0 (可选)或Material Router
- **UI组件**: Material Design 3

## 依赖关系
- 无前置依赖
- 可与任务002(后端API)并行开发
- 使用Mock数据先行开发

## 验收标准
### 功能完整性
- [x] Flutter项目可在Android/iOS平台运行
- [x] 路由系统支持页面导航和守卫
- [x] Provider状态管理架构搭建完成
- [x] Dio网络层封装完成,支持JWT注入
- [x] Hive本地存储集成,Token持久化
- [x] 主题配置支持深浅色模式
- [x] Mock数据服务可独立运行

### 代码质量
- [x] 代码遵循Flutter/Dart规范
- [x] 关键类有文档注释
- [x] 无明显性能问题
- [x] 错误处理完善

### 测试覆盖
- [x] Provider状态管理单元测试
- [x] 网络请求Mock测试
- [x] 路由跳转集成测试

## 风险与挑战
| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| Flutter开发不熟悉 | 高 | 参考官方示例,使用成熟UI库 |
| Provider状态管理复杂 | 中 | 先设计状态树,再实现 |
| iOS配置复杂 | 中 | 优先Android开发,iOS后续补充 |

## 备注
- 优先Android平台开发,iOS配置可后续补充
- Mock数据结构需与后端API保持一致
- 网络层需支持后续切换到真实API
- 预留多语言支持能力(可选)

## 后续任务
- 任务007: Flutter核心功能开发(依赖本任务)
- 任务008: Flutter高级功能开发(依赖任务007)
