---
name: 管理后台API实现
status: open
created: 2025-12-31T13:44:17Z
updated: 2025-12-31T13:44:17Z
github: [Will be updated when synced to GitHub]
depends_on: ["002", "003", "004"]
parallel: true
conflicts_with: []
---

# Task: 管理后台API实现

## Description
实现完整的管理后台API系统，包含管理员认证、全局订单管理、商品管理、统计分析（今日数据、趋势分析、热销商品）、用户管理、评价管理和操作审计日志。

## Acceptance Criteria
- [ ] 管理员认证系统完成（独立JWT认证）
- [ ] 全局订单管理接口（查看、筛选、状态更新、导出）
- [ ] 商品管理接口（CRUD、批量操作、库存调整）
- [ ] 统计分析API（今日订单、销售额、趋势图表、热销商品Top10）
- [ ] 用户管理接口（查看、禁用/启用、权限管理）
- [ ] 评价管理接口（查看、删除不当评价、回复）
- [ ] 操作审计日志（记录所有管理员操作）
- [ ] 权限控制（仅管理员可访问）
- [ ] 数据导出功能（CSV/Excel）

## Technical Details

### 管理员认证设计
```python
# users表扩展：
# - is_admin: Boolean（管理员标识）
# - role: enum（admin, staff, super_admin）

# 管理员登录流程：
# 1. POST /api/admin/auth/login
# 2. 验证is_admin=True
# 3. 返回admin专用JWT（claim中包含role）
# 4. 后续请求需要Bearer token

# 依赖注入：
# async def get_current_admin(token: str) -> Admin:
#     if not user.is_admin:
#         raise HTTPException(403, "需要管理员权限")
```

### API接口设计

#### 管理员认证 (/api/admin/auth)
- `POST /api/admin/auth/login` - 管理员登录
- `POST /api/admin/auth/logout` - 管理员登出
- `POST /api/admin/auth/refresh` - 刷新token
- `GET /api/admin/auth/me` - 获取当前管理员信息

#### 订单管理 (/api/admin/orders)
- `GET /api/admin/orders` - 全局订单列表（支持筛选用户、状态、日期、价格区间）
- `GET /api/admin/orders/{id}` - 订单详情（含用户信息、商品信息）
- `PUT /api/admin/orders/{id}/status` - 更新订单状态
- `GET /api/admin/orders/export` - 导出订单数据（CSV/Excel）
- `GET /api/admin/orders/stats` - 订单统计（按状态、按日期）

#### 商品管理 (/api/admin/products)
- `GET /api/admin/products` - 商品列表（支持所有筛选）
- `POST /api/admin/products` - 创建商品
- `PUT /api/admin/products/{id}` - 更新商品
- `DELETE /api/admin/products/{id}` - 删除商品
- `PUT /api/admin/products/{id}/stock` - 调整库存（批量增减）
- `POST /api/admin/products/batch` - 批量操作（批量上架/下架/删除）

#### 统计分析 (/api/admin/analytics)
- `GET /api/admin/analytics/today` - 今日数据（订单数、销售额、新增用户）
- `GET /api/admin/analytics/trend` - 趋势分析（7天/30天趋势图）
- `GET /api/admin/analytics/hot-products` - 热销商品Top10
- `GET /api/admin/analytics/categories` - 分类销售占比
- `GET /api/admin/analytics/users` - 用户增长统计

#### 用户管理 (/api/admin/users)
- `GET /api/admin/users` - 用户列表（分页、搜索）
- `GET /api/admin/users/{id}` - 用户详情（订单历史、总消费）
- `PUT /api/admin/users/{id}/status` - 禁用/启用用户
- `PUT /api/admin/users/{id}/role` - 修改用户角色

#### 评价管理 (/api/admin/reviews)
- `GET /api/admin/reviews` - 全局评价列表（支持筛选）
- `DELETE /api/admin/reviews/{id}` - 删除不当评价
- `POST /api/admin/reviews/{id}/reply` - 管理员回复评价

#### 审计日志 (/api/admin/audit-logs)
- `GET /api/admin/audit-logs` - 查看审计日志（按管理员、操作类型、日期筛选）
- `GET /api/admin/audit-logs/{id}` - 查看日志详情

### 统计分析实现

#### 今日数据
```python
async def get_today_stats():
    now = datetime.now()
    start_of_day = now.replace(hour=0, minute=0, second=0)

    # 查询今日订单
    today_orders = await session.execute(
        select(Order).where(Order.created_at >= start_of_day)
    )

    return {
        "order_count": len(today_orders),
        "total_sales": sum(order.total_amount for order in today_orders),
        "new_users": ...,
        "avg_order_value": ...
    }
```

#### 趋势分析
```python
# 7天趋势
async def get_trend(days: int = 7):
    trend_data = []
    for i in range(days):
        date = datetime.now() - timedelta(days=i)
        start = date.replace(hour=0, minute=0)
        end = date.replace(hour=23, minute=59)

        daily_orders = await session.execute(
            select(Order).where(Order.created_at.between(start, end))
        )

        trend_data.append({
            "date": date.strftime("%Y-%m-%d"),
            "orders": len(daily_orders),
            "sales": sum(...)
        })

    return trend_data[::-1]  # 按日期正序
```

#### 热销商品
```python
async def get_hot_products(limit: int = 10):
    # SQL: JOIN order_items + products, GROUP BY product_id, ORDER BY SUM(quantity)
    stmt = select(
        Product.name,
        func.sum(OrderItem.quantity).label('total_sold'),
        func.sum(OrderItem.subtotal).label('total_revenue')
    ).join(OrderItem).group_by(Product.id).order_by(
        desc('total_sold')
    ).limit(limit)

    return await session.execute(stmt)
```

### 操作审计日志
```python
# 记录所有管理员操作
async def log_admin_action(
    admin_id: int,
    action: str,  # "create_order", "update_product", "delete_review"
    target_type: str,  # "order", "product", "user"
    target_id: int,
    details: dict
):
    log = AdminLog(
        admin_id=admin_id,
        action=action,
        target_type=target_type,
        target_id=target_id,
        details=details
    )
    session.add(log)
    await session.commit()

# 使用示例：
await log_admin_action(
    admin_id=current_admin.id,
    action="update_order_status",
    target_type="order",
    target_id=order_id,
    details={"old_status": "paid", "new_status": "preparing"}
)
```

### 数据导出
```python
# CSV导出
import csv
from fastapi.responses import StreamingResponse

async def export_orders():
    # 1. 查询订单数据
    orders = await get_all_orders()

    # 2. 生成CSV
    output = io.StringIO()
    writer = csv.writer(output)
    writer.writerow(["订单ID", "用户", "金额", "状态", "创建时间"])

    for order in orders:
        writer.writerow([
            order.id, order.user.username,
            order.total_amount, order.status,
            order.created_at
        ])

    # 3. 返回文件流
    return StreamingResponse(
        io.BytesIO(output.getvalue().encode('utf-8-sig')),
        media_type='text/csv',
        headers={"Content-Disposition": "attachment; filename=orders.csv"}
    )
```

### 权限控制
```python
# 路由级权限控制
@router.get("/admin/orders")
async def get_admin_orders(
    current_admin: Admin = Depends(get_current_admin)
):
    # 只有is_admin=True的用户才能访问
    ...

# 依赖注入
async def get_current_admin(token: str = Depends(oauth2_scheme)):
    user = await decode_token(token)
    if not user.is_admin:
        raise HTTPException(403, "需要管理员权限")
    return user
```

### 涉及的文件
- `/Volumes/545S/general final/backend/app/routers/admin/`
- `/Volumes/545S/general final/backend/app/services/admin_service.py`
- `/Volumes/545S/general final/backend/app/services/analytics_service.py`
- `/Volumes/545S/general final/backend/app/models/admin.py`
- `/Volumes/545S/general final/backend/app/schemas/admin.py`
- `/Volumes/545S/general final/backend/app/utils/export.py`
- `/Volumes/545S/general final/backend/tests/test_admin.py`

## Dependencies
- [x] 任务002: 后端基础设施完成（数据库、认证）
- [x] 任务003: 商品和购物车API完成
- [x] 任务004: 订单和评价API完成
- [ ] 管理员账户已创建（is_admin=True）

## Effort Estimate
- Size: L
- Hours: 20小时
  - 管理员认证系统：3小时
  - 订单管理接口：3小时
  - 商品管理接口：3小时
  - 统计分析API：5小时
  - 用户和评价管理：3小时
  - 审计日志和导出：3小时
- Parallel: true（可与任务003、004并行）

## Definition of Done
- [ ] 管理员可以登录并访问所有管理接口
- [ ] 普通用户访问管理接口返回403错误
- [ ] 统计数据准确（与数据库查询结果一致）
- [ ] 热销商品Top10查询响应时间<1秒
- [ ] 订单导出CSV包含所有必要字段
- [ ] 所有管理员操作都有审计日志记录
- [ ] API文档包含管理员专用接口说明
- [ ] 单元测试覆盖权限控制逻辑
- [ ] 包含管理后台使用手册（README.md）
