---
name: 商品和购物车API实现
status: open
created: 2025-12-31T13:44:17Z
updated: 2025-12-31T13:44:17Z
github: [Will be updated when synced to GitHub]
depends_on: ["002"]
parallel: true
conflicts_with: []
---

# Task: 商品和购物车API实现

## Description
实现商品分类、商品管理、商品搜索和购物车的完整CRUD接口，包含库存管理、库存检查、购物车自动合并等核心业务逻辑。

## Acceptance Criteria
- [ ] 商品分类CRUD接口完整（创建、读取、更新、删除、列表）
- [ ] 商品CRUD接口完整（含库存管理字段）
- [ ] 商品搜索接口支持模糊搜索、价格区间、分类筛选、排序
- [ ] 购物车CRUD接口完整（添加、删除、更新数量、清空、查看）
- [ ] 库存检查逻辑（添加商品到购物车时检查库存）
- [ ] 购物车自动合并（同一商品多次添加自动合并数量）
- [ ] 所有接口包含认证、权限控制、输入验证
- [ ] 单元测试覆盖率>80%

## Technical Details

### API接口设计

#### 商品分类接口 (/api/categories)
- `GET /api/categories` - 获取所有分类（支持分页）
- `GET /api/categories/{id}` - 获取单个分类详情
- `POST /api/categories` - 创建分类（管理员）
- `PUT /api/categories/{id}` - 更新分类（管理员）
- `DELETE /api/categories/{id}` - 删除分类（管理员，级联处理商品）

#### 商品接口 (/api/products)
- `GET /api/products` - 获取商品列表（支持分页、筛选、排序）
- `GET /api/products/{id}` - 获取商品详情
- `POST /api/products` - 创建商品（管理员）
- `PUT /api/products/{id}` - 更新商品（管理员）
- `DELETE /api/products/{id}` - 删除商品（管理员）
- `GET /api/products/search` - 商品搜索（模糊匹配、价格区间、分类）

#### 购物车接口 (/api/cart)
- `GET /api/cart` - 查看购物车（当前用户）
- `POST /api/cart` - 添加商品到购物车
- `PUT /api/cart/items/{id}` - 更新购物车商品数量
- `DELETE /api/cart/items/{id}` - 删除购物车商品
- `DELETE /api/cart` - 清空购物车
- `GET /api/cart/summary` - 获取购物车汇总（总数量、总金额）

### 业务逻辑实现

#### 商品搜索
```python
# 搜索参数：keyword（模糊）, category_id, min_price, max_price, sort_by
# 排序方式：price_asc, price_desc, created_at, sales
# 使用SQLAlchemy动态构建查询（filter_by + like + between）
# Redis缓存热门搜索结果
```

#### 库存检查
```python
async def add_to_cart(user_id: int, product_id: int, quantity: int):
    # 1. 检查商品是否存在
    # 2. 检查库存是否充足
    # 3. 检查购物车是否已有该商品
    # 4. 如果有，更新数量；否则新增
    # 5. 返回更新后的购物车
```

#### 购物车合并
```python
# 用户登录时合并未登录购物车和登录购物车
# 同一商品多次添加：quantity累加
# 超过库存限制：提示用户
```

#### 库存管理
```python
# 商品表字段：
# - stock: 当前库存
# - sales: 销量（用于排序和统计）
# - status: 上架/下架

# 库存更新策略：
# - 添加到购物车：不扣减库存
# - 提交订单：扣减库存（事务锁）
# - 取消订单：恢复库存
```

### Pydantic Schema设计
```python
class CategoryBase(BaseModel):
    name: str
    description: Optional[str]
    sort_order: int = 0

class ProductBase(BaseModel):
    name: str
    description: Optional[str]
    price: Decimal
    stock: int
    category_id: int
    image_url: Optional[str]

class CartItemBase(BaseModel):
    product_id: int
    quantity: int = Field(gt=0, le=100)

class ProductSearchQuery(BaseModel):
    keyword: Optional[str]
    category_id: Optional[int]
    min_price: Optional[Decimal]
    max_price: Optional[Decimal]
    sort_by: str = "created_at"
```

### 技术要点
- **异步SQLAlchemy**: `async_session_maker` + `select` + `insert` + `update`
- **缓存策略**: 商品列表缓存（TTL 5分钟），商品详情缓存（TTL 10分钟）
- **分页**: `limit` + `offset`，返回total_count
- **验证**: Pydantic验证（价格>0，库存>=0，数量>0）
- **权限**: Depends(get_current_user)，管理员操作额外验证
- **错误处理**: HTTPException（400输入错误，401未认证，403未授权，404未找到）

### 性能优化
- 商品列表使用Redis缓存
- 搜索使用数据库索引（name, category_id, price）
- 批量查询购物车商品（`select * from products where id in (...)`）
- 使用`selectinload`预加载分类数据

### 涉及的文件
- `/Volumes/545S/general final/backend/app/routers/categories.py`
- `/Volumes/545S/general final/backend/app/routers/products.py`
- `/Volumes/545S/general final/backend/app/routers/cart.py`
- `/Volumes/545S/general final/backend/app/services/product_service.py`
- `/Volumes/545S/general final/backend/app/services/cart_service.py`
- `/Volumes/545S/general final/backend/app/schemas/product.py`
- `/Volumes/545S/general final/backend/tests/test_products.py`
- `/Volumes/545S/general final/backend/tests/test_cart.py`

## Dependencies
- [x] 任务002: 后端基础设施完成（数据库、认证、Redis）
- [ ] 商品数据已导入（任务001）
- [ ] pytest和pytest-asyncio测试环境

## Effort Estimate
- Size: M
- Hours: 16小时
  - 商品分类接口：2小时
  - 商品CRUD接口：3小时
  - 商品搜索接口：3小时
  - 购物车接口：4小时
  - 库存检查和合并逻辑：2小时
  - 单元测试：2小时
- Parallel: true（可与任务004并行）

## Definition of Done
- [ ] 所有接口在Swagger UI中可交互测试
- [ ] 商品搜索响应时间<200ms
- [ ] 购物车操作支持并发安全（数据库锁）
- [ ] 单元测试通过（pytest test_products test_cart）
- [ ] 接口文档完整（包含请求/响应示例）
- [ ] 代码通过linting（black + flake8）
- [ ] 错误场景测试覆盖（库存不足、商品不存在）
