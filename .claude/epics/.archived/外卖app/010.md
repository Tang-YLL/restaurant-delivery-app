---
id: 010
epic: 外卖app
title: 测试和部署
status: pending
effort: L (24小时)
dependencies: [005, 008, 009]
parallel: false
assignee: []
labels: [testing, deployment, devops, production]
priority: high
created: 2025-12-31T13:44:17Z
updated: 2025-12-31T13:44:17Z
---

# 任务 010: 测试和部署

## 概述

完成外卖配送系统的全面测试，包括单元测试、集成测试、性能测试和功能测试。基于Docker容器化部署所有服务，配置Nginx反向代理和SSL证书，实现生产环境部署。配置日志监控和健康检查，确保系统稳定运行。

## 技术栈

**测试工具**
- **Python测试**: pytest + pytest-cov + pytest-asyncio
- **API测试**: Postman + Newman
- **Flutter测试**: flutter test + integration_test
- **Vue3测试**: Vitest + Vue Test Utils
- **性能测试**: Locust

**部署工具**
- **容器化**: Docker + Docker Compose
- **Web服务器**: Nginx
- **反向代理**: Nginx
- **SSL**: Let's Encrypt (certbot)

**监控工具**
- **日志**: Python logging + 结构化JSON
- **健康检查**: FastAPI /health 端点
- **性能监控**: 日志分析(可选)

## 详细任务

### 1. Python后端单元测试 (5小时)

**测试框架配置**
- 安装pytest和相关依赖
```bash
pip install pytest pytest-cov pytest-asyncio pytest-mock
```
- 配置pytest.ini
- 配置覆盖率目标(≥70%)
- 配置测试数据库(独立于开发数据库)

**核心业务逻辑测试**
- 订单创建逻辑测试
  - 正常订单创建
  - 库存不足异常
  - 并发订单库存扣减
  - 订单金额计算
- 订单状态流转测试
  - 状态机验证
  - 状态流转权限
  - 状态回滚异常
- 购物车逻辑测试
  - 添加商品
  - 更新数量
  - 删除商品
  - 清空购物车
- 用户认证测试
  - 注册逻辑
  - 登录验证
  - JWT生成和验证
  - 密码加密

**数据层测试**
- CRUD操作测试
- 数据库事务测试
- Redis缓存测试
- 数据关联查询测试

**API接口测试**
- 使用pytest测试FastAPI路由
- 请求参数验证测试
- 响应格式测试
- 错误处理测试
- 权限控制测试

**覆盖率要求**
- 核心业务逻辑 ≥ 80%
- API接口 ≥ 70%
- 数据层 ≥ 60%
- 整体覆盖率 ≥ 70%

### 2. API集成测试 (3小时)

**Postman测试集合**
- 创建完整的API测试集合
- 用户端API测试
  - 注册/登录
  - 商品浏览
  - 购物车操作
  - 订单创建和查询
  - 评价提交
- 管理端API测试
  - 管理员登录
  - 订单管理
  - 商品管理
  - 统计查询
- 环境变量配置
  - 开发环境
  - 测试环境
  - 生产环境

**Newman自动化**
- 导出Postman Collection
- 编写Newman测试脚本
- 集成到CI/CD流程
- 生成测试报告

**接口测试场景**
- 正常流程测试
- 异常输入测试
- 边界条件测试
- 并发请求测试
- 认证授权测试

**测试数据准备**
- 准备测试账号
- 准备测试商品数据
- 准备测试订单数据
- 数据清理脚本

### 3. Flutter功能测试 (3小时)

**单元测试**
- Widget测试
- Provider状态管理测试
- 工具函数测试
- 业务逻辑测试

**集成测试**
- 用户注册/登录流程
- 商品浏览和搜索
- 购物车操作
- 下单流程
  - 选择配送方式
  - 模拟支付
  - 订单创建
- 订单查询和详情
- 评价提交
- 个人中心功能

**测试场景**
```dart
// 主要测试场景
- 完整购买流程(注册→浏览→加购→下单→支付→查看订单)
- 订单取消流程
- 评价提交流程
- 地址管理流程
- 搜索商品流程
```

**测试覆盖率**
- 核心业务逻辑 ≥ 60%
- 主要UI交互 ≥ 50%

### 4. Vue3组件测试 (2小时)

**测试框架配置**
- 安装Vitest和Vue Test Utils
```bash
npm install -D vitest @vue/test-utils
```
- 配置vitest.config.ts

**组件测试**
- 登录组件测试
- 表单验证测试
- 表格组件测试
- 分页组件测试
- 搜索组件测试
- 通知组件测试

**状态管理测试**
- Pinia Store测试
- 状态持久化测试
- 状态更新逻辑测试

**API调用测试**
- Mock API响应
- Axios拦截器测试
- 错误处理测试

**测试覆盖率**
- 核心组件 ≥ 50%

### 5. 性能测试 (4小时)

**Locust性能测试**
- 安装Locust
```bash
pip install locust
```

**测试场景设计**
- 用户注册/登录场景
- 商品浏览场景
- 购物车操作场景
- 下单场景
- 订单查询场景

**并发测试计划**
- 10并发用户 - 基准测试
- 50并发用户 - 中等负载
- 100并发用户 - 高负载测试
- 200并发用户 - 压力测试

**性能指标**
- API响应时间 P95 < 500ms
- API响应时间 P99 < 1s
- 数据库查询 < 100ms
- 错误率 < 0.1%
- 系统吞吐量 ≥ 100 req/s

**性能优化**
- 数据库慢查询优化
- API响应缓存
- Redis缓存优化
- 数据库连接池调整
- Nginx缓存配置

**测试报告**
- 响应时间分布
- 并发用户数vs吞吐量
- 错误率统计
- 瓶颈分析

### 6. Docker容器化部署 (3小时)

**Dockerfile编写**

**Python后端Dockerfile**
```dockerfile
FROM python:3.9-slim
WORKDIR /app
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt
COPY . .
CMD ["gunicorn", "app.main:app", "-w", "4", "-k", "uvicorn.workers.UvicornWorker", "--bind", "0.0.0.0:8000"]
```

**Vue3管理后台Dockerfile**
```dockerfile
FROM node:16-alpine as builder
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
RUN npm run build

FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf
```

**Flutter应用**
- 构建APK/IPA(本地构建)
- 可选: 使用Docker构建Web版本

**Docker Compose配置**
```yaml
version: '3.8'
services:
  fastapi:
    build: ./backend
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=postgresql://user:pass@postgres:5432/food_delivery
      - REDIS_URL=redis://redis:6379
    depends_on:
      - postgres
      - redis
    volumes:
      - ./Material:/app/Material

  postgres:
    image: postgres:14
    environment:
      - POSTGRES_DB=food_delivery
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=pass
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/data

  vue-admin:
    build: ./admin-frontend
    ports:
      - "8080:80"

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/ssl:/etc/nginx/ssl
      - ./Material:/usr/share/nginx/html/Material
    depends_on:
      - fastapi
      - vue-admin

volumes:
  postgres_data:
  redis_data:
```

### 7. Nginx配置 (2小时)

**反向代理配置**
```nginx
server {
    listen 80;
    server_name your-domain.com;

    # Vue3管理后台
    location /admin {
        proxy_pass http://vue-admin;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # FastAPI后端
    location /api {
        proxy_pass http://fastapi:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # WebSocket支持
    location /ws {
        proxy_pass http://fastapi:8000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # 静态文件(图片)
    location /static {
        alias /usr/share/nginx/html/Material/material;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
}
```

**SSL证书配置**
```nginx
server {
    listen 443 ssl http2;
    server_name your-domain.com;

    ssl_certificate /etc/nginx/ssl/fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # 其他配置同上
}

server {
    listen 80;
    server_name your-domain.com;
    return 301 https://$server_name$request_uri;
}
```

**SSL证书申请**
```bash
# 使用Let's Encrypt
sudo apt-get install certbot
sudo certbot certonly --standalone -d your-domain.com
# 复制证书到nginx/ssl目录
```

**性能优化**
- Gzip压缩
- 静态文件缓存
- Keepalive连接
- 请求体大小限制
- 超时配置

### 8. 生产环境部署 (2小时)

**服务器准备**
- 云服务器购买(阿里云ECS/腾讯云CVM)
- 操作系统配置(Ubuntu 22.04 LTS)
- Docker和Docker Compose安装
- 防火墙配置(开放80, 443端口)

**数据库迁移**
- 生产数据库创建
- Alembic迁移执行
- 静态数据导入(Material文件夹)
- 管理员账号创建

**应用部署**
- 代码上传(Git Clone)
- 环境变量配置(.env.production)
- Docker Compose启动
```bash
docker-compose -f docker-compose.prod.yml up -d
```
- 容器状态检查
- 日志查看

**域名配置**
- 域名DNS解析
- A记录指向服务器IP
- SSL证书申请和配置
- HTTP重定向HTTPS

### 9. 监控和日志配置 (2小时)

**日志配置**
- Python logging配置
  - 结构化JSON日志
  - 日志分级(DEBUG, INFO, WARNING, ERROR)
  - 文件轮转
  - 请求日志
- Nginx访问日志和错误日志
- Docker日志收集

**健康检查**
- FastAPI /health 端点
  - 数据库连接检查
  - Redis连接检查
  - 返回系统状态
- Docker健康检查
- Nginx状态监控(可选)

**监控工具(可选)**
- Prometheus + Grafana
- Sentry错误追踪
- 云服务商监控工具

**备份策略**
- 数据库定期备份
- 静态文件备份
- 配置文件备份
- 备份脚本定时任务

### 10. 上线验证和文档 (1小时)

**功能验证**
- 用户注册/登录测试
- 商品浏览测试
- 下单流程测试
- 管理后台登录测试
- 订单管理测试
- WebSocket通知测试
- 支付流程测试(模拟支付)

**性能验证**
- API响应时间测试
- 页面加载速度测试
- 并发用户测试

**文档编写**
- 部署文档
  - 服务器要求
  - 部署步骤
  - 环境变量说明
  - 常见问题
- 运维文档
  - 启动/停止命令
  - 日志查看
  - 数据库备份
  - 故障排查
- API文档(FastAPI自动生成)
- 用户使用手册

## 验收标准

### 测试覆盖率
- [ ] Python后端单元测试覆盖率 ≥ 70%
- [ ] API集成测试全部通过
- [ ] Flutter核心功能测试通过
- [ ] Vue3核心组件测试通过
- [ ] 性能测试达标(100并发用户无性能降级)

### 部署完整性
- [ ] 所有服务成功容器化
- [ ] Docker Compose一键启动成功
- [ ] Nginx反向代理配置正确
- [ ] SSL证书配置成功
- [ ] 生产环境成功部署
- [ ] 域名可以HTTPS访问

### 功能可用性
- [ ] 用户可以正常注册登录
- [ ] 商品浏览正常
- [ ] 下单流程完整可用
- [ ] 管理后台功能正常
- [ ] 实时通知正常工作
- [ ] 静态文件(图片)正常加载

### 性能标准
- [ ] API响应时间 P95 < 500ms
- [ ] 页面加载时间 < 3秒
- [ ] 100并发用户无错误
- [ ] 系统可用性 ≥ 99%

### 安全标准
- [ ] 所有API接口JWT认证
- [ ] HTTPS加密传输
- [ ] 密码bcrypt加密存储
- [ ] SQL注入防护
- [ ] XSS防护
- [ ] Rate Limiting防刷

### 监控和运维
- [ ] 日志记录正常
- [ ] 健康检查正常
- [ ] 数据库备份配置完成
- [ ] 监控告警配置完成(可选)

## 依赖关系

**前置依赖**
- 任务005 (订单和评价API) - 后端API完成
- 任务008 (Flutter高级功能) - Flutter应用完成
- 任务009 (Vue3管理后台) - Vue3应用完成

**后续任务**
- 无(最后阶段)

## 风险和缓解

**测试风险**
- **风险**: 测试覆盖率不足
- **缓解**: 核心业务逻辑优先测试,逐步提高覆盖率

**性能风险**
- **风险**: 性能测试未达标
- **缓解**: 提前进行性能测试,预留优化时间

**部署风险**
- **风险**: 生产环境部署失败
- **缓解**: 先在测试环境完整验证,准备回滚方案

**安全风险**
- **风险**: 安全漏洞未发现
- **缓解**: 进行安全测试,使用最新依赖版本

## 预期成果

1. **完整的测试套件**: 单元测试、集成测试、性能测试
2. **测试报告**: 覆盖率报告、性能测试报告
3. **Docker镜像**: 所有服务的Docker镜像
4. **生产环境**: 可访问的生产系统
5. **部署文档**: 完整的部署和运维文档
6. **监控配置**: 日志和监控配置

## 时间分配

- Python后端单元测试: 5小时
- API集成测试: 3小时
- Flutter功能测试: 3小时
- Vue3组件测试: 2小时
- 性能测试: 4小时
- Docker容器化部署: 3小时
- Nginx配置: 2小时
- 生产环境部署: 2小时
- 监控和日志配置: 2小时
- 上线验证和文档: 1小时

**总计**: 24小时 (3个工作日)

## 附录

### 测试命令示例

**Python后端测试**
```bash
# 运行所有测试
pytest

# 运行测试并生成覆盖率报告
pytest --cov=app --cov-report=html

# 运行特定测试文件
pytest tests/test_orders.py

# 运行性能测试
pytest tests/performance/
```

**Flutter测试**
```bash
# 运行所有测试
flutter test

# 运行集成测试
flutter test integration_test/

# 生成覆盖率报告
flutter test --coverage
```

**Vue3测试**
```bash
# 运行所有测试
npm run test

# 运行测试并生成覆盖率报告
npm run test:coverage
```

**性能测试**
```bash
# 启动Locust
locust -f locustfile.py --host=http://your-domain.com

# 无头模式运行
locust -f locustfile.py --headless -u 100 -r 10 -t 1m
```

### 部署命令示例

**Docker部署**
```bash
# 构建镜像
docker-compose build

# 启动服务
docker-compose up -d

# 查看日志
docker-compose logs -f

# 停止服务
docker-compose down

# 重启服务
docker-compose restart
```

**数据库备份**
```bash
# 备份数据库
docker exec postgres pg_dump -U user food_delivery > backup.sql

# 恢复数据库
docker exec -i postgres psql -U user food_delivery < backup.sql
```
