---
id: "008"
title: "Flutter高级功能与UI优化"
epic: "外卖app"
status: "backlog"
assigned: ""
labels: ["flutter", "advanced", "ui", "optimization"]
priority: "medium"
effort: "L"  # 20 hours
dependencies: ["007"]
parallel: true
created: "2025-12-31T13:44:17Z"
updated: "2025-12-31T13:44:17Z"
---

# 任务008: Flutter高级功能与UI优化

## 目标
开发Flutter移动端高级功能,包括评价系统、个人中心、地址管理,并进行UI/UX优化,提升用户体验和应用性能。

## 背景
基于任务007的核心功能,补充完善用户体验相关的功能模块。可与Vue3管理后台(任务005)并行开发,不阻塞整体进度。

## 详细任务

### 1. 评价系统 (4h)
**技术要求**
- 星级评分组件(可交互、可显示)
- 文字评价输入
- 图片上传(可选,最多3张)
- 提交评价
- 评价列表(商品详情页显示)
- 评分统计(平均分、评价数量)

**1.1 评价页面**
```dart
class ReviewPage extends StatefulWidget {
  final String orderId;

  ReviewPage({required this.orderId});

  @override
  State<ReviewPage> createState() => _ReviewPageState();
}

class _ReviewPageState extends State<ReviewPage> {
  final Map<String, int> _ratings = {};
  final Map<String, TextEditingController> _controllers = {};
  final List<File> _images = [];
  bool _isSubmitting = false;

  @override
  void didChangeDependencies() {
    super.didChangeDependencies();

    final order = ModalRoute.of(context)!.settings.arguments as Order;
    for (var item in order.items) {
      _ratings[item.productId] = 5;
      _controllers[item.productId] = TextEditingController();
    }
  }

  Future<void> _handleSubmit() async {
    setState(() => _isSubmitting = true);

    try {
      final reviews = _ratings.entries.map((entry) {
        return CreateReviewRequest(
          productId: entry.key,
          orderId: widget.orderId,
          rating: entry.value,
          content: _controllers[entry.key]!.text,
        );
      }).toList();

      await ApiClient.createReviews(reviews);

      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('评价成功')),
      );

      Navigator.pop(context);
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('评价失败: $e')),
      );
    } finally {
      setState(() => _isSubmitting = false);
    }
  }

  @override
  Widget build(BuildContext context) {
    final order = ModalRoute.of(context)!.settings.arguments as Order;

    return Scaffold(
      appBar: AppBar(title: Text('评价订单')),
      body: Column(
        children: [
          Expanded(
            child: ListView(
              padding: EdgeInsets.all(16),
              children: order.items.map((item) {
                return Card(
                  margin: EdgeInsets.only(bottom: 16),
                  child: Padding(
                    padding: EdgeInsets.all(16),
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(item.productName,
                            style: TextStyle(fontWeight: FontWeight.bold)),
                        SizedBox(height: 12),

                        // 星级评分
                        Row(
                          children: List.generate(5, (index) {
                            return IconButton(
                              icon: Icon(
                                index < _ratings[item.productId]!
                                    ? Icons.star
                                    : Icons.star_border,
                                color: Colors.orange,
                              ),
                              onPressed: () {
                                setState(() {
                                  _ratings[item.productId] = index + 1;
                                });
                              },
                            );
                          }),
                        ),

                        SizedBox(height: 12),

                        // 评价内容
                        TextField(
                          controller: _controllers[item.productId],
                          maxLines: 3,
                          decoration: InputDecoration(
                            hintText: '分享你的用餐体验...',
                            border: OutlineInputBorder(),
                          ),
                        ),

                        SizedBox(height: 12),

                        // 图片上传(可选)
                        OutlinedButton.icon(
                          onPressed: () => _pickImages(item.productId),
                          icon: Icon(Icons.add_photo_alternate),
                          label: Text('添加图片'),
                        ),
                      ],
                    ),
                  ),
                );
              }).toList(),
            ),
          ),

          // 提交按钮
          Container(
            padding: EdgeInsets.all(16),
            child: SafeArea(
              child: SizedBox(
                width: double.infinity,
                child: ElevatedButton(
                  onPressed: _isSubmitting ? null : _handleSubmit,
                  child: _isSubmitting
                      ? CircularProgressIndicator()
                      : Text('提交评价'),
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }

  Future<void> _pickImages(String productId) async {
    // 实现图片选择逻辑(image_picker)
    // 最多3张图片
  }
}
```

**1.2 星级评分组件**
```dart
class StarRating extends StatelessWidget {
  final int rating;
  final int maxRating;
  final double size;
  final bool interactive;
  final Function(int)? onRatingChanged;

  StarRating({
    required this.rating,
    this.maxRating = 5,
    this.size = 24,
    this.interactive = false,
    this.onRatingChanged,
  });

  @override
  Widget build(BuildContext context) {
    return Row(
      mainAxisSize: MainAxisSize.min,
      children: List.generate(maxRating, (index) {
        return Icon(
          index < rating ? Icons.star : Icons.star_border,
          color: Colors.orange,
          size: size,
        );
      }),
    );
  }
}
```

**验收标准**
- [ ] 星级评分交互正常
- [ ] 评价内容可提交
- [ ] 图片上传功能正常(可选)
- [ ] 评价列表显示正确

### 2. 个人中心 (4h)
**技术要求**
- 用户信息展示(头像、昵称、手机号)
- 订单历史入口
- 功能列表(地址管理、个人资料、设置等)
- 退出登录
- 头像点击跳转个人资料

**个人中心页面**
```dart
class ProfilePage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    final user = context.watch<UserProvider>().user;

    return Scaffold(
      body: CustomScrollView(
        slivers: [
          // 顶部用户信息
          SliverToBoxAdapter(
            child: Container(
              padding: EdgeInsets.all(24),
              color: Theme.of(context).primaryColor,
              child: SafeArea(
                child: Column(
                  children: [
                    // 头像
                    GestureDetector(
                      onTap: () {
                        Navigator.pushNamed(context, Routes.profileEdit);
                      },
                      child: CircleAvatar(
                        radius: 40,
                        backgroundImage: user?.avatar != null
                            ? NetworkImage(user!.avatar!)
                            : null,
                        child: user?.avatar == null
                            ? Icon(Icons.person, size: 40)
                            : null,
                      ),
                    ),
                    SizedBox(height: 16),

                    // 昵称
                    Text(
                      user?.nickname ?? '未登录',
                      style: TextStyle(
                        fontSize: 20,
                        fontWeight: FontWeight.bold,
                        color: Colors.white,
                      ),
                    ),
                    SizedBox(height: 8),

                    // 手机号
                    Text(
                      user?.phone ?? '',
                      style: TextStyle(color: Colors.white70),
                    ),
                  ],
                ),
              ),
            ),
          ),

          // 功能列表
          SliverList(
            delegate: SliverChildListDelegate([
              ListTile(
                leading: Icon(Icons.receipt_long),
                title: Text('我的订单'),
                trailing: Icon(Icons.chevron_right),
                onTap: () {
                  Navigator.pushNamed(context, Routes.orders);
                },
              ),
              Divider(),

              ListTile(
                leading: Icon(Icons.location_on),
                title: Text('收货地址'),
                trailing: Icon(Icons.chevron_right),
                onTap: () {
                  Navigator.pushNamed(context, Routes.addresses);
                },
              ),
              Divider(),

              ListTile(
                leading: Icon(Icons.person),
                title: Text('个人资料'),
                trailing: Icon(Icons.chevron_right),
                onTap: () {
                  Navigator.pushNamed(context, Routes.profileEdit);
                },
              ),
              Divider(),

              ListTile(
                leading: Icon(Icons.settings),
                title: Text('设置'),
                trailing: Icon(Icons.chevron_right),
                onTap: () {
                  Navigator.pushNamed(context, Routes.settings);
                },
              ),
              Divider(),

              // 退出登录
              Padding(
                padding: EdgeInsets.all(16),
                child: OutlinedButton(
                  onPressed: () async {
                    final confirmed = await showDialog<bool>(
                      context: context,
                      builder: (context) => AlertDialog(
                        title: Text('退出登录'),
                        content: Text('确定要退出登录吗?'),
                        actions: [
                          TextButton(
                            onPressed: () => Navigator.pop(context, false),
                            child: Text('取消'),
                          ),
                          TextButton(
                            onPressed: () => Navigator.pop(context, true),
                            child: Text('确定'),
                          ),
                        ],
                      ),
                    );

                    if (confirmed == true) {
                      context.read<UserProvider>().logout();
                      Navigator.pushReplacementNamed(context, Routes.login);
                    }
                  },
                  child: Text('退出登录'),
                ),
              ),
            ]),
          ),
        ],
      ),
    );
  }
}
```

**验收标准**
- [ ] 用户信息显示正确
- [ ] 功能列表跳转正常
- [ ] 退出登录功能正常

### 3. 地址管理 (4h)
**技术要求**
- 地址列表(显示、选择默认地址)
- 新增地址(表单验证)
- 编辑地址
- 删除地址
- 设置默认地址
- 智能定位(可选,使用geolocator)

**3.1 地址管理页面**
```dart
class AddressListPage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text('收货地址')),
      body: FutureBuilder<List<Address>>(
        future: ApiClient.getAddresses(),
        builder: (context, snapshot) {
          if (snapshot.connectionState == ConnectionState.waiting) {
            return Center(child: CircularProgressIndicator());
          }

          if (snapshot.hasError) {
            return Center(child: Text('加载失败'));
          }

          final addresses = snapshot.data!;

          return addresses.isEmpty
              ? Center(child: Text('暂无收货地址'))
              : ListView.builder(
                  padding: EdgeInsets.all(16),
                  itemCount: addresses.length,
                  itemBuilder: (context, index) {
                    final address = addresses[index];
                    return AddressCard(
                      address: address,
                      onEdit: () {
                        Navigator.pushNamed(
                          context,
                          Routes.addressEdit,
                          arguments: address,
                        );
                      },
                      onDelete: () async {
                        final confirmed = await showDialog<bool>(
                          context: context,
                          builder: (context) => AlertDialog(
                            title: Text('删除地址'),
                            content: Text('确定要删除该地址吗?'),
                            actions: [
                              TextButton(
                                onPressed: () => Navigator.pop(context, false),
                                child: Text('取消'),
                              ),
                              TextButton(
                                onPressed: () => Navigator.pop(context, true),
                                child: Text('确定'),
                              ),
                            ],
                          ),
                        );

                        if (confirmed == true) {
                          try {
                            await ApiClient.deleteAddress(address.id);
                            ScaffoldMessenger.of(context).showSnackBar(
                              SnackBar(content: Text('删除成功')),
                            );
                            // 刷新列表
                          } catch (e) {
                            ScaffoldMessenger.of(context).showSnackBar(
                              SnackBar(content: Text('删除失败: $e')),
                            );
                          }
                        }
                      },
                      onSetDefault: () async {
                        try {
                          await ApiClient.setDefaultAddress(address.id);
                          ScaffoldMessenger.of(context).showSnackBar(
                            SnackBar(content: Text('已设置为默认地址')),
                          );
                          // 刷新列表
                        } catch (e) {
                          ScaffoldMessenger.of(context).showSnackBar(
                            SnackBar(content: Text('设置失败: $e')),
                          );
                        }
                      },
                    );
                  },
                );
        },
      ),
      floatingActionButton: FloatingActionButton(
        onPressed: () {
          Navigator.pushNamed(context, Routes.addressEdit);
        },
        child: Icon(Icons.add),
        tooltip: '新增地址',
      ),
    );
  }
}
```

**3.2 地址编辑页面**
```dart
class AddressEditPage extends StatefulWidget {
  final Address? address;

  AddressEditPage({this.address});

  @override
  State<AddressEditPage> createState() => _AddressEditPageState();
}

class _AddressEditPageState extends State<AddressEditPage> {
  final _formKey = GlobalKey<FormState>();
  final _nameController = TextEditingController();
  final _phoneController = TextEditingController();
  final _addressController = TextEditingController();
  final _detailController = TextEditingController();
  bool _isDefault = false;
  bool _isSubmitting = false;

  @override
  void initState() {
    super.initState();
    if (widget.address != null) {
      _nameController.text = widget.address!.name;
      _phoneController.text = widget.address!.phone;
      _addressController.text = widget.address!.address;
      _detailController.text = widget.address!.detail ?? '';
      _isDefault = widget.address!.isDefault;
    }
  }

  Future<void> _handleSubmit() async {
    if (!_formKey.currentState!.validate()) return;

    setState(() => _isSubmitting = true);

    try {
      if (widget.address == null) {
        await ApiClient.createAddress(CreateAddressRequest(
          name: _nameController.text,
          phone: _phoneController.text,
          address: _addressController.text,
          detail: _detailController.text,
          isDefault: _isDefault,
        ));
      } else {
        await ApiClient.updateAddress(
          widget.address!.id,
          UpdateAddressRequest(
            name: _nameController.text,
            phone: _phoneController.text,
            address: _addressController.text,
            detail: _detailController.text,
            isDefault: _isDefault,
          ),
        );
      }

      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('保存成功')),
      );

      Navigator.pop(context);
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('保存失败: $e')),
      );
    } finally {
      setState(() => _isSubmitting = false);
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text(widget.address == null ? '新增地址' : '编辑地址')),
      body: Form(
        key: _formKey,
        child: ListView(
          padding: EdgeInsets.all(16),
          children: [
            TextFormField(
              controller: _nameController,
              decoration: InputDecoration(
                labelText: '收货人',
                border: OutlineInputBorder(),
              ),
              validator: (value) {
                if (value == null || value.isEmpty) return '请输入收货人';
                return null;
              },
            ),
            SizedBox(height: 16),

            TextFormField(
              controller: _phoneController,
              keyboardType: TextInputType.phone,
              decoration: InputDecoration(
                labelText: '联系电话',
                border: OutlineInputBorder(),
              ),
              validator: (value) {
                if (value == null || value.isEmpty) return '请输入联系电话';
                if (!RegExp(r'^1[3-9]\d{9}$').hasMatch(value)) {
                  return '手机号格式错误';
                }
                return null;
              },
            ),
            SizedBox(height: 16),

            TextFormField(
              controller: _addressController,
              decoration: InputDecoration(
                labelText: '收货地址',
                border: OutlineInputBorder(),
              ),
              validator: (value) {
                if (value == null || value.isEmpty) return '请输入收货地址';
                return null;
              },
            ),
            SizedBox(height: 16),

            TextFormField(
              controller: _detailController,
              decoration: InputDecoration(
                labelText: '详细地址(选填)',
                border: OutlineInputBorder(),
              ),
            ),
            SizedBox(height: 16),

            SwitchListTile(
              title: Text('设为默认地址'),
              value: _isDefault,
              onChanged: (value) => setState(() => _isDefault = value),
            ),
            SizedBox(height: 24),

            SizedBox(
              width: double.infinity,
              child: ElevatedButton(
                onPressed: _isSubmitting ? null : _handleSubmit,
                child: _isSubmitting
                    ? CircularProgressIndicator()
                    : Text('保存'),
              ),
            ),
          ],
        ),
      ),
    );
  }
}
```

**验收标准**
- [ ] 地址列表显示正常
- [ ] 新增/编辑地址功能正常
- [ ] 删除地址功能正常
- [ ] 设置默认地址功能正常
- [ ] 表单验证正确

### 4. 个人资料编辑 (2h)
**技术要求**
- 头像上传(可选)
- 昵称编辑
- 手机号显示(不可修改)
- 保存修改

**个人资料编辑页面**
```dart
class ProfileEditPage extends StatefulWidget {
  @override
  State<ProfileEditPage> createState() => _ProfileEditPageState();
}

class _ProfileEditPageState extends State<ProfileEditPage> {
  final _formKey = GlobalKey<FormState>();
  late TextEditingController _nicknameController;
  String? _avatar;
  bool _isSubmitting = false;

  @override
  void didChangeDependencies() {
    super.didChangeDependencies();
    final user = context.watch<UserProvider>().user!;
    _nicknameController = TextEditingController(text: user.nickname);
    _avatar = user.avatar;
  }

  Future<void> _handleSubmit() async {
    if (!_formKey.currentState!.validate()) return;

    setState(() => _isSubmitting = true);

    try {
      await ApiClient.updateProfile(UpdateProfileRequest(
        nickname: _nicknameController.text,
        avatar: _avatar,
      ));

      // 刷新用户信息
      await context.read<UserProvider>().refresh();

      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('保存成功')),
      );

      Navigator.pop(context);
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('保存失败: $e')),
      );
    } finally {
      setState(() => _isSubmitting = false);
    }
  }

  @override
  Widget build(BuildContext context) {
    final user = context.watch<UserProvider>().user!;

    return Scaffold(
      appBar: AppBar(title: Text('个人资料')),
      body: Form(
        key: _formKey,
        child: ListView(
          padding: EdgeInsets.all(16),
          children: [
            // 头像
            Center(
              child: GestureDetector(
                onTap: () async {
                  // 实现头像选择逻辑
                },
                child: Stack(
                  children: [
                    CircleAvatar(
                      radius: 50,
                      backgroundImage: _avatar != null
                          ? NetworkImage(_avatar!)
                          : null,
                      child: _avatar == null
                          ? Icon(Icons.person, size: 50)
                          : null,
                    ),
                    Positioned(
                      bottom: 0,
                      right: 0,
                      child: CircleAvatar(
                        backgroundColor: Colors.blue,
                        child: Icon(Icons.camera_alt, color: Colors.white),
                      ),
                    ),
                  ],
                ),
              ),
            ),
            SizedBox(height: 32),

            // 昵称
            TextFormField(
              controller: _nicknameController,
              decoration: InputDecoration(
                labelText: '昵称',
                border: OutlineInputBorder(),
              ),
              validator: (value) {
                if (value == null || value.isEmpty) return '请输入昵称';
                return null;
              },
            ),
            SizedBox(height: 16),

            // 手机号(不可修改)
            TextFormField(
              enabled: false,
              initialValue: user.phone,
              decoration: InputDecoration(
                labelText: '手机号',
                border: OutlineInputBorder(),
              ),
            ),
            SizedBox(height: 24),

            // 保存按钮
            SizedBox(
              width: double.infinity,
              child: ElevatedButton(
                onPressed: _isSubmitting ? null : _handleSubmit,
                child: _isSubmitting
                    ? CircularProgressIndicator()
                    : Text('保存'),
              ),
            ),
          ],
        ),
      ),
    );
  }
}
```

**验收标准**
- [ ] 昵称可编辑并保存
- [ ] 头像可上传(可选)
- [ ] 手机号正确显示

### 5. UI/UX优化 (6h)
**技术要求**
- 页面转场动画( Hero动画 )
- 骨架屏加载(Skeleton)
- 下拉刷新/上拉加载
- 手势交互(滑动删除、长按)
- 动画效果(按钮点击、列表滑动)
- 空状态页面
- 错误页面

**5.1 骨架屏加载**
```dart
class ProductSkeleton extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Card(
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // 图片占位
          Container(
            height: 150,
            color: Colors.grey[300],
          ),
          Padding(
            padding: EdgeInsets.all(8),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                // 标题占位
                Container(
                  height: 16,
                  width: double.infinity,
                  color: Colors.grey[300],
                ),
                SizedBox(height: 8),

                // 价格占位
                Container(
                  height: 14,
                  width: 60,
                  color: Colors.grey[300],
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }
}
```

**5.2 Hero动画示例**
```dart
// 商品列表页
Hero(
  tag: 'product_${product.id}',
  child: Image.network(product.imageUrl),
);

// 商品详情页
Hero(
  tag: 'product_${product.id}',
  child: Image.network(product.imageUrl),
)
```

**5.3 下拉刷新**
```dart
RefreshIndicator(
  onRefresh: _loadProducts,
  child: ListView.builder(
    // ...
  ),
)
```

**5.4 滑动删除(购物车)**
```dart
Dismissible(
  key: Key(item.product.id),
  direction: DismissDirection.endToStart,
  onDismissed: (direction) {
    context.read<CartProvider>().removeItem(item.product.id);
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(content: Text('已删除')),
    );
  },
  background: Container(
    color: Colors.red,
    alignment: Alignment.centerRight,
    padding: EdgeInsets.only(right: 16),
    child: Icon(Icons.delete, color: Colors.white),
  ),
  child: CartItemCard(item: item),
)
```

**验收标准**
- [ ] 页面转场动画流畅
- [ ] 骨架屏加载显示正常
- [ ] 下拉刷新功能正常
- [ ] 滑动删除交互流畅
- [ ] 空状态页面友好
- [ ] 错误页面友好

## 技术栈
- **UI组件**: Material Design 3
- **动画**: Hero、AnimatedContainer、AnimationController
- **手势**: GestureDetector、Dismissible
- **图片上传**: image_picker (可选)
- **定位**: geolocator (可选)

## 依赖关系
- 依赖任务007: Flutter核心功能
- 可与任务005(Vue3管理后台)并行开发

## 验收标准
### 功能完整性
- [x] 评价系统功能完整
- [x] 个人中心功能完整
- [x] 地址管理CRUD完整
- [x] 个人资料可编辑

### UI/UX体验
- [x] 页面转场流畅
- [x] 加载状态提示友好
- [x] 空状态/错误状态友好
- [x] 手势交互流畅
- [x] 动画效果自然

### 代码质量
- [x] 代码遵循Flutter/Dart规范
- [x] 组件复用性高
- [x] 动画性能优化
- [x] 无明显卡顿

### 性能要求
- [x] 页面帧率 ≥ 60fps
- [x] 列表滑动流畅
- [x] 图片加载优化(缓存)

## 风险与挑战
| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| 图片上传功能复杂 | 低 | 使用image_picker库,简化逻辑 |
| 动画性能问题 | 中 | 使用AnimatedBuilder优化 |
| 手势冲突 | 低 | 使用GestureDetector carefully |

## 备注
- 图片上传功能可选,可简化为不实现
- 智能定位功能可选,可简化为手动输入地址
- UI优化是迭代过程,优先核心功能
- 动画效果需适度,避免过度设计

## 后续任务
- 任务009: 测试和部署(依赖所有开发任务)
