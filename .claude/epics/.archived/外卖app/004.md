---
name: 订单和评价API实现
status: open
created: 2025-12-31T13:44:17Z
updated: 2025-12-31T13:44:17Z
github: [Will be updated when synced to GitHub]
depends_on: ["002", "003"]
parallel: true
conflicts_with: []
---

# Task: 订单和评价API实现

## Description
实现完整的订单管理系统和评价功能，包含订单创建、订单状态机（7种状态）、订单查询管理、评价系统（1-5星、文字、图片）、并发安全的库存扣减、事务处理和回滚机制。

## Acceptance Criteria
- [ ] 订单创建接口完成（含库存扣减和事务处理）
- [ ] 订单状态机实现（7种状态及其转换规则）
- [ ] 订单查询接口（列表、详情、筛选、分页）
- [ ] 订单状态更新接口（用户取消、管理员操作）
- [ ] 评价系统CRUD接口（评分、文字、图片）
- [ ] 并发安全库存扣减（SELECT FOR UPDATE）
- [ ] 事务回滚机制（库存不足、支付失败）
- [ ] 订单统计接口（用户订单数量、总金额）
- [ ] 单元测试覆盖并发场景

## Technical Details

### 订单状态机设计
```
状态流转：
pending（待支付）→ paid（已支付）→ preparing（准备中）→ delivering（配送中）→ completed（已完成）
                                     ↓
                                  cancelled（已取消）
                                  refunded（已退款）

转换规则：
- 用户操作：pending→cancelled（取消订单）
- 管理员操作：paid→preparing→delivering→completed
- 自动操作：pending超时→cancelled（15分钟未支付）
```

### API接口设计

#### 订单接口 (/api/orders)
- `POST /api/orders` - 创建订单（扣减库存、计算总价）
- `GET /api/orders` - 获取用户订单列表（分页、状态筛选）
- `GET /api/orders/{id}` - 获取订单详情
- `PUT /api/orders/{id}/cancel` - 取消订单（恢复库存）
- `PUT /api/orders/{id}/status` - 更新订单状态（管理员）
- `GET /api/orders/stats` - 订单统计（总订单、总金额、状态分布）

#### 订单明细接口
- 自动创建（订单创建时生成order_items记录）
- `GET /api/orders/{id}/items` - 获取订单商品列表

#### 评价接口 (/api/reviews)
- `POST /api/reviews` - 创建评价（只能评价已完成订单）
- `GET /api/reviews` - 获取评价列表（分页、商品筛选、评分筛选）
- `GET /api/reviews/{id}` - 获取评价详情
- `PUT /api/reviews/{id}` - 更新评价（只能修改自己的评价）
- `DELETE /api/reviews/{id}` - 删除评价
- `GET /api/products/{id}/reviews` - 获取商品所有评价
- `GET /api/products/{id}/rating` - 获取商品平均评分

### 并发安全库存扣减
```python
from sqlalchemy import select, update

async def create_order(user_id: int, items: List[OrderItemCreate]):
    async with AsyncSession() as session:
        async with session.begin():
            # 1. 检查库存（FOR UPDATE行锁）
            product_stmt = select(Product).where(
                Product.id.in_([item.product_id for item in items])
            ).with_for_update()
            products = await session.execute(product_stmt)

            # 2. 验证库存
            for item in items:
                product = products.get(item.product_id)
                if product.stock < item.quantity:
                    raise HTTPException(400, f"商品 {product.name} 库存不足")

            # 3. 扣减库存
            for item in items:
                await session.execute(
                    update(Product)
                    .where(Product.id == item.product_id)
                    .values(stock=Product.stock - item.quantity)
                )

            # 4. 创建订单和订单明细
            order = Order(user_id=user_id, total_amount=total)
            session.add(order)
            session.flush()  # 获取order.id

            for item in items:
                order_item = OrderItem(
                    order_id=order.id,
                    product_id=item.product_id,
                    quantity=item.quantity,
                    price=item.price,
                    subtotal=item.quantity * item.price
                )
                session.add(order_item)

            # 5. 提交事务
            await session.commit()
            return order
```

### 事务处理和回滚
```python
# 场景1：库存不足 → 回滚，返回错误
# 场景2：支付失败 → 回滚，恢复库存
# 场景3：部分商品无库存 → 询问用户是否拆单（未来功能）

# 实现方式：async with session.begin(): 自动回滚
```

### 评价系统设计
```python
# reviews表字段：
# - id, user_id, order_id, product_id
# - rating: 1-5（必填）
# - content: 文字评价（可选，最多500字）
# - images: JSON数组（可选，最多3张）
# - created_at, updated_at

# 约束：
# - 只能评价已完成订单（status=completed）
# - 每个订单商品只能评价一次
# - 删除订单时级联删除评价
```

### 订单计算逻辑
```python
# 总价计算：
# total_amount = sum(item.price * item.quantity for item in items)

# 优惠逻辑（预留）：
# - 满减优惠券
# - 会员折扣
# - 新用户优惠
```

### Pydantic Schema
```python
class OrderItemCreate(BaseModel):
    product_id: int
    quantity: int = Field(gt=0)

class OrderCreate(BaseModel):
    items: List[OrderItemCreate]
    shipping_address: str = Field(min_length=5, max_length=200)

class ReviewCreate(BaseModel):
    order_id: int
    product_id: int
    rating: int = Field(ge=1, le=5)
    content: Optional[str] = Field(max_length=500)
    images: Optional[List[str]] = Field(max_length=3)
```

### 涉及的文件
- `/Volumes/545S/general final/backend/app/routers/orders.py`
- `/Volumes/545S/general final/backend/app/routers/reviews.py`
- `/Volumes/545S/general final/backend/app/services/order_service.py`
- `/Volumes/545S/general final/backend/app/services/review_service.py`
- `/Volumes/545S/general final/backend/app/schemas/order.py`
- `/Volumes/545S/general final/backend/app/models/order.py`
- `/Volumes/545S/general final/backend/tests/test_orders.py`
- `/Volumes/545S/general final/backend/tests/test_reviews.py`

### 性能优化
- 订单列表使用Redis缓存（用户维度的订单列表）
- 评价数据缓存（商品评分缓存）
- 使用数据库索引（user_id, status, created_at）
- 订单统计使用预计算（定时任务更新）

## Dependencies
- [x] 任务002: 后端基础设施完成
- [x] 任务003: 商品和购物车API完成
- [ ] 商品数据完整（含库存字段）

## Effort Estimate
- Size: L
- Hours: 20小时
  - 订单创建和库存扣减：6小时
  - 订单状态机实现：4小时
  - 订单查询和管理：3小时
  - 评价系统实现：4小时
  - 事务处理和并发测试：3小时
- Parallel: true（可与任务003、005并行）

## Definition of Done
- [ ] 订单创建接口测试通过（库存正确扣减）
- [ ] 并发测试通过（100个并发订单创建）
- [ ] 订单状态转换符合规则（状态机验证）
- [ ] 评价只能在订单完成后创建
- [ ] 取消订单后库存恢复正确
- [ ] 事务回滚场景测试通过（故意触发错误验证）
- [ ] 单元测试覆盖率>80%
- [ ] API文档完整（包含状态转换图）
- [ ] 性能测试：订单创建<500ms
