# 任务015: Vue3管理系统自动化测试

**状态**: pending
**工时**: 20小时
**优先级**: P1 - 高
**依赖**: 无（可与任务014并行进行）

## 任务目标

为Vue3管理系统搭建完整的自动化测试框架，实现单元测试、组件测试和E2E测试。

## 当前状态

**Vue3管理系统现状**:
- ✅ 项目已创建：`vue-admin/`
- ✅ 技术栈：Vue3 + TypeScript + Vite + Element Plus + Pinia + ECharts
- ✅ 核心页面：登录、订单管理、商品管理、数据统计、用户管理
- ❌ 尚未配置任何测试框架
- ❌ 无测试用例

## 子任务

### 1. 单元测试框架搭建 (3h)

#### 1.1 安装测试依赖
- [ ] 安装Vitest：`npm install -D vitest @vitest/ui`
- [ ] 安装Vue Test Utils：`npm install -D @vue/test-utils`
- [ ] 安装覆盖率工具：`npm install -D @vitest/coverage-v8`
- [ ] 安装测试辅助库：`npm install -D @testing-library/vue @testing-library/user-event`

#### 1.2 配置Vitest
- [ ] 创建`vitest.config.ts`配置文件
- [ ] 配置测试环境（jsdom环境）
- [ ] 配置覆盖率阈值（目标：60%）
- [ ] 配置TypeScript支持
- [ ] 添加测试脚本到package.json

```json
"scripts": {
  "test": "vitest",
  "test:ui": "vitest --ui",
  "test:coverage": "vitest --coverage"
}
```

#### 1.3 创建测试工具和Mock
- [ ] 创建测试工具函数（`src/tests/utils/test-utils.ts`）
- [ ] 配置Axios Mock（msw或axios-mock-adapter）
- [ ] 配置Pinia测试工具
- [ ] 配置Vue Router测试工具
- [ ] 创建测试数据fixtures

### 2. 组件单元测试 (6h)

#### 2.1 通用UI组件测试
- [ ] 测试Element Plus组件封装（如果有）
- [ ] 测试表单组件（验证、提交、错误处理）
- [ ] 测试表格组件（排序、筛选、分页）
- [ ] 测试弹窗组件（打开、关闭、确认）

#### 2.2 登录认证组件测试
- [ ] `Login.vue`组件测试
  - [ ] 表单验证测试（用户名、密码）
  - [ ] 登录成功测试
  - [ ] 登录失败测试（错误提示）
  - [ ] 记住我功能测试
  - [ ] Token存储测试

#### 2.3 订单管理组件测试
- [ ] `Orders.vue`订单列表测试
  - [ ] 订单列表渲染
  - [ ] 状态筛选功能
  - [ ] 分页功能
  - [ ] 订单详情查看
- [ ] `OrderDetail.vue`测试
  - [ ] 订单信息显示
  - [ ] 状态更新功能
  - [ ] 订单取消功能

#### 2.4 商品管理组件测试
- [ ] `Products.vue`商品列表测试
  - [ ] 商品CRUD操作
  - [ ] 搜索和筛选
  - [ ] 批量操作
- [ ] 商品表单测试（添加/编辑）
  - [ ] 表单验证
  - [ ] 图片上传
  - [ ] 价格和库存验证

#### 2.5 数据统计组件测试
- [ ] `Dashboard.vue`测试
  - [ ] 数据卡片渲染
  - [ ] ECharts图表显示
  - [ ] 数据刷新功能
  - [ ] 时间范围筛选

#### 2.6 用户管理组件测试
- [ ] `Users.vue`测试
  - [ ] 用户列表显示
  - [ ] 用户状态切换
  - [ ] 用户权限管理

### 3. Vue Store状态管理测试 (4h)

#### 3.1 用户状态测试（`stores/user.ts`）
- [ ] 登录action测试
- [ ] 登出action测试
- [ ] Token刷新测试
- [ ] 用户信息获取测试
- [ ] 权限验证测试

#### 3.2 订单状态测试（`stores/order.ts`）
- [ ] 订单列表获取测试
- [ ] 订单详情获取测试
- [ ] 订单状态更新测试
- [ ] 订单筛选和分页测试
- [ ] 统计数据获取测试

#### 3.3 商品状态测试（`stores/product.ts`）
- [ ] 商品列表获取测试
- [ ] 商品CRUD操作测试
- [ ] 分类管理测试
- [ ] 库存管理测试

#### 3.4 通知状态测试（`stores/notification.ts`）
- [ ] WebSocket连接测试
- [ ] 消息接收测试
- [ ] 消息已读状态测试
- [ ] 消息清除测试

### 4. API集成测试 (3h)

#### 4.1 Axios拦截器测试
- [ ] 请求拦截器测试（JWT注入）
- [ ] 响应拦截器测试（错误处理）
- [ ] Token刷新逻辑测试
- [ ] 401自动登出测试

#### 4.2 API客户端测试
- [ ] 订单API测试（mock响应）
- [ ] 商品API测试（mock响应）
- [ ] 用户API测试（mock响应）
- [ ] 统计API测试（mock响应）
- [ ] 错误处理测试

#### 4.3 WebSocket连接测试
- [ ] 连接建立测试
- [ ] 消息接收测试
- [ ] 重连机制测试
- [ ] 断线处理测试

### 5. E2E测试（Playwright）(4h)

#### 5.1 配置Playwright
- [ ] 安装Playwright：`npm install -D @playwright/test`
- [ ] 创建`playwright.config.ts`
- [ ] 配置测试浏览器（Chromium、Firefox、WebKit）
- [ ] 配置测试base URL

#### 5.2 编写E2E测试用例
- [ ] 管理员登录流程
  - [ ] 访问登录页
  - [ ] 输入用户名密码
  - [ ] 验证登录成功
  - [ ] 验证跳转到Dashboard
- [ ] 订单处理完整流程
  - [ ] 查看订单列表
  - [ ] 筛选订单
  - [ ] 查看订单详情
  - [ ] 更新订单状态
  - [ ] 导出订单数据
- [ ] 商品管理流程
  - [ ] 添加新商品
  - [ ] 编辑商品
  - [ ] 上架/下架商品
  - [ ] 删除商品
- [ ] 数据统计查看
  - [ ] 访问Dashboard
  - [ ] 查看统计数据
  - [ ] 筛选时间范围
  - [ ] 查看图表

### 6. CI/CD集成 (可选，2h)

- [ ] 配置GitHub Actions工作流
- [ ] 自动运行测试
- [ ] 生成测试报告
- [ ] 覆盖率上传（Codecov）

## 验收标准

### 必须达成
- [ ] Vitest测试框架配置完成
- [ ] 所有核心组件有单元测试覆盖
- [ ] 所有Store有状态管理测试
- [ ] E2E测试覆盖主要业务流程
- [ ] 测试覆盖率 ≥ 60%
- [ ] 所有测试可自动运行

### 期望达成
- [ ] 测试执行时间 < 2分钟
- [ ] E2E测试稳定（无flaky tests）
- [ ] 测试报告自动生成
- [ ] CI/CD集成完成

## 技术要求

- **测试框架**: Vitest
- **组件测试**: Vue Test Utils + @testing-library/vue
- **E2E测试**: Playwright
- **覆盖率工具**: @vitest/coverage-v8
- **Mock**: msw (Mock Service Worker) 或 vitest fixture

## 风险和注意事项

1. **ECharts测试复杂**: ECharts图表渲染测试较复杂，可考虑使用mock或快照测试
2. **WebSocket测试**: 真实WebSocket测试较困难，建议使用mock
3. **异步测试**: 注意async/await和act()包裹
4. **Element Plus组件**: Element Plus组件测试可能需要特殊配置

## 相关文件

- Vue项目: `vue-admin/`
- 测试配置: `vue-admin/vitest.config.ts`
- 测试文件: `vue-admin/src/**/*.test.ts`
- E2E测试: `vue-admin/e2e/`
- 覆盖率报告: `vue-admin/coverage/index.html`

## 测试文件结构示例

```
vue-admin/
├── src/
│   ├── tests/
│   │   ├── unit/              # 单元测试
│   │   │   ├── components/     # 组件测试
│   │   │   ├── stores/         # Store测试
│   │   │   └── api/            # API测试
│   │   ├── e2e/               # E2E测试
│   │   ├── fixtures/          # 测试数据
│   │   └── mocks/             # Mock数据
│   └── vitest.setup.ts        # Vitest设置
├── e2e/                       # Playwright E2E测试
├── vitest.config.ts
└── playwright.config.ts
```

## 下一步

完成本任务后，可以开始：
- 任务016: 端到端接口测试与App集成验证
