# 任务014: 后端API自动化测试完善

**状态**: in-progress
**工时**: 16小时
**优先级**: P0 - 紧急
**依赖**: 无

## 任务目标

完善后端API自动化测试，确保测试覆盖率达到70%以上，所有测试用例通过。

## 当前状态

**测试现状（2026-01-01）**:
- ✅ 已有87个测试用例（pytest + pytest-asyncio）
- ⚠️ 通过率：50.6% (44/87 passed, 29 failed, 14 error)
- ⚠️ 覆盖率：43.88%
- ❌ 主要问题：
  - 密码哈希bcrypt限制（已修复 ✅）
  - API路由前缀问题（已修复 ✅）
  - admin路由注册问题（已修复 ✅）
  - 部分业务逻辑测试缺失
  - 集成测试用例不足

## 子任务

### 1. 修复现有测试失败问题 (4h)

#### 1.1 修复密码哈希问题 ✅
- [x] 修改`app/core/security.py`中的`get_password_hash`函数
- [x] 添加72字节截断逻辑
- [x] 验证密码哈希和验证功能

#### 1.2 修复API路由问题 ✅
- [x] 修改测试文件中的API路径（`/api/v1/` → `/api/`）
- [x] 重命名`admin.py`为`admin_auth.py`避免导入冲突
- [x] 在`main.py`中注册`admin_auth.router`
- [x] 验证所有路由可访问

#### 1.3 修复测试数据初始化问题 (2h)
- [ ] 检查fixture中的测试数据格式
- [ ] 修复数据库依赖注入问题
- [ ] 确保测试数据正确清理
- [ ] 验证测试隔离性

#### 1.4 修复业务逻辑测试失败 (2h)
- [ ] 分析29个失败的测试用例
- [ ] 修复用户认证测试（注册、登录、token刷新）
- [ ] 修复购物车测试（添加、更新、删除）
- [ ] 修复订单测试（创建、支付、取消）
- [ ] 修复评价测试（创建、更新、删除）

### 2. 提升测试覆盖率至70%以上 (6h)

#### 2.1 Repository层测试 (2h)
- [ ] UserRepository测试（CRUD、查询、统计）
- [ ] ProductRepository测试（搜索、筛选、分页）
- [ ] OrderRepository测试（状态转换、库存扣减）
- [ ] ReviewRepository测试（评分计算、统计）

#### 2.2 Service层业务逻辑测试 (2h)
- [ ] AuthService测试（注册、登录、token生成）
- [ ] OrderService测试（订单创建、状态机、库存管理）
- [ ] CartService测试（购物车操作、金额计算）
- [ ] ProductService测试（商品管理、库存控制）
- [ ] ReviewService测试（评价创建、审核、统计）

#### 2.3 Security模块测试 (1h)
- [ ] JWT token生成和验证测试
- [ ] 密码哈希和验证测试
- [ ] Token过期和刷新测试
- [ ] 权限验证测试（用户/管理员）

#### 2.4 Redis客户端测试 (1h)
- [ ] Redis连接测试
- [ ] 缓存读写测试
- [ ] Pub/Sub测试（订单通知）
- [ ] 数据过期测试

### 3. 完善集成测试 (3h)

#### 3.1 端到端API流程测试 (1.5h)
- [ ] 用户注册→登录→浏览商品→加入购物车→下单→支付
- [ ] 管理员登录→查看订单→接单→更新状态→完成
- [ ] 商品管理流程（创建→编辑→上架→下架）
- [ ] 评价流程（下单→完成→评价→管理员回复）

#### 3.2 管理后台API流程测试 (1h)
- [ ] 管理员认证和权限测试
- [ ] 订单管理完整流程测试
- [ ] 数据统计接口测试
- [ ] 审计日志测试

#### 3.3 并发测试和竞态条件测试 (0.5h)
- [ ] 多用户同时下单测试
- [ ] 库存并发扣减测试
- [ ] 订单状态并发更新测试

### 4. 性能测试 (2h)

#### 4.1 Locust压力测试
- [ ] 编写Locust测试脚本（已存在locustfile.py）
- [ ] 配置100并发用户场景
- [ ] 执行压力测试
- [ ] 分析性能瓶颈

#### 4.2 API响应时间基准测试
- [ ] 测试所有API端点的响应时间
- [ ] 验证P95 < 500ms要求
- [ ] 验证P99 < 1s要求
- [ ] 识别慢查询并优化

#### 4.3 数据库查询性能测试
- [ ] 分析慢查询日志
- [ ] 测试索引有效性
- [ ] 优化N+1查询问题
- [ ] 验证连接池配置

### 5. CI/CD集成 (1h)

#### 5.1 Docker容器内测试执行
- [ ] 配置Docker容器测试环境
- [ ] 编写docker-compose.test.yml
- [ ] 验证容器内测试运行

#### 5.2 测试报告生成
- [ ] 配置pytest生成HTML覆盖率报告
- [ ] 配置JUnit XML报告（用于CI集成）
- [ ] 配置测试结果通知

#### 5.3 自动化测试流程
- [ ] 编写测试运行脚本
- [ ] 配置GitHub Actions（可选）
- [ ] 配置测试失败告警

## 验收标准

### 必须达成
- [ ] 所有87个测试用例通过（100%通过率）
- [ ] 代码覆盖率达到70%以上
- [ ] Locust压力测试通过（100并发用户）
- [ ] API响应时间P95 < 500ms
- [ ] Docker容器内测试可执行

### 期望达成
- [ ] 测试通过率保持稳定（连续10次运行全部通过）
- [ ] 测试执行时间 < 5分钟（快速反馈）
- [ ] 测试报告自动生成和归档

## 技术要求

- 使用pytest + pytest-asyncio + pytest-cov
- 使用httpx进行异步API测试
- 使用SQLite内存数据库进行测试
- 使用faker生成测试数据
- 使用Locust进行性能测试

## 风险和注意事项

1. **测试数据污染**: 确保每个测试用例独立运行，使用fixture进行数据清理
2. **异步测试超时**: 某些异步操作可能超时，需要调整测试超时时间
3. **Mock数据真实性**: Mock数据应尽可能接近真实场景
4. **性能测试环境**: 性能测试应在隔离环境中进行，避免影响其他测试

## 相关文件

- 测试配置: `backend/pytest.ini`
- 测试fixture: `backend/tests/conftest.py`
- 测试用例: `backend/tests/test_*.py`
- 覆盖率报告: `backend/htmlcov/index.html`
- 性能测试: `backend/locustfile.py`

## 下一步

完成本任务后，可以开始：
- 任务015: Vue3管理系统自动化测试
- 任务016: 端到端接口测试与App集成验证
