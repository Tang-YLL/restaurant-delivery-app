---
name: 后端基础设施 - FastAPI项目架构与数据库设计
status: open
created: 2025-12-31T13:44:17Z
updated: 2025-12-31T13:44:17Z
github: [Will be updated when synced to GitHub]
depends_on: ["001"]
parallel: false
conflicts_with: []
---

# Task: 后端基础设施 - FastAPI项目架构与数据库设计

## Description
搭建FastAPI后端项目架构，设计并实现8个核心数据库表，配置Redis缓存和JWT双token认证系统，使用Alembic管理数据库迁移，创建Docker Compose开发环境。

## Acceptance Criteria
- [ ] FastAPI项目结构完整（分层架构：routers, services, models, schemas）
- [ ] 8个核心数据库表设计完成并创建迁移脚本
- [ ] Redis连接配置完成，缓存辅助函数封装
- [ ] JWT认证系统实现（access token 15分钟 + refresh token 7天）
- [ ] Alembic初始迁移生成并执行成功
- [ ] Docker Compose可一键启动开发环境（FastAPI + PostgreSQL + Redis）
- [ ] API文档自动生成（Swagger UI和ReDoc）

## Technical Details

### 项目结构
```
backend/
├── app/
│   ├── main.py              # FastAPI应用入口
│   ├── config.py            # 配置管理（环境变量）
│   ├── dependencies.py      # 依赖注入
│   ├── database.py          # 数据库连接
│   ├── redis.py             # Redis连接
│   ├── auth.py              # JWT认证逻辑
│   ├── models/              # SQLAlchemy模型
│   │   ├── user.py
│   │   ├── category.py
│   │   ├── product.py
│   │   ├── cart.py
│   │   ├── order.py
│   │   ├── review.py
│   │   ├── admin.py
│   │   └── __init__.py
│   ├── schemas/             # Pydantic模型
│   ├── routers/             # API路由
│   ├── services/            # 业务逻辑层
│   ├── core/                # 核心功能（安全、密码哈希）
│   └── utils/               # 工具函数
├── alembic/                 # 数据库迁移
├── tests/                   # 测试
├── Dockerfile
├── docker-compose.yml
└── requirements.txt
```

### 8个核心数据库表设计
1. **users** - 用户表
   - id, username, email, password_hash, phone, is_active, created_at
2. **categories** - 商品分类表
   - id, name, description, sort_order
3. **products** - 商品表
   - id, name, description, price, stock, category_id, image_url, created_at
4. **carts** - 购物车表
   - id, user_id, product_id, quantity, created_at
5. **orders** - 订单表
   - id, user_id, total_amount, status, shipping_address, created_at
6. **order_items** - 订单明细表
   - id, order_id, product_id, quantity, price, subtotal
7. **reviews** - 评价表
   - id, user_id, order_id, product_id, rating, content, images, created_at
8. **admin_logs** - 管理员操作日志表
   - id, admin_id, action, target_type, target_id, details, created_at

### JWT认证实现
```python
# access token: 15分钟
# refresh token: 7天
# /auth/login 返回双token
# /auth/refresh 刷新access token
# /auth/logout 注销（黑名单）
```

### Redis使用场景
- Session存储
- 购物车缓存
- 热门商品缓存
- JWT黑名单（注销token）
- 接口限流

### Alembic配置
- 初始化：`alembic init alembic`
- env.py配置：异步SQLAlchemy
- 生成迁移：`alembic revision --autogenerate -m "initial"`
- 执行迁移：`alembic upgrade head`

### Docker Compose服务
```yaml
services:
  fastapi:
    build: .
    ports: ["8000:8000"]
    depends_on: [postgres, redis]
  postgres:
    image: postgres:15
    environment: POSTGRES_PASSWORD=secret
    volumes: ["postgres_data:/var/lib/postgresql/data"]
  redis:
    image: redis:7-alpine
```

### 技术栈
- **框架**: FastAPI 0.104+
- **数据库**: PostgreSQL 15 + SQLAlchemy 2.0 (async)
- **缓存**: Redis 7 + aioredis
- **认证**: JWT (python-jose)
- **迁移**: Alembic
- **容器**: Docker + Docker Compose
- **验证**: Pydantic v2
- **密码**: passlib (bcrypt)

### 涉及的文件
- `/Volumes/545S/general final/backend/app/main.py`
- `/Volumes/545S/general final/backend/app/models/`
- `/Volumes/545S/general final/backend/alembic/`
- `/Volumes/545S/general final/backend/docker-compose.yml`
- `/Volumes/545S/general final/backend/requirements.txt`

## Dependencies
- [x] 任务001: 数据准备完成（数据库有初始商品数据）
- [ ] Docker和Docker Compose已安装
- [ ] Python 3.10+
- [ ] PostgreSQL和Redis环境

## Effort Estimate
- Size: L
- Hours: 24小时
  - 项目结构搭建：3小时
  - 数据库模型设计：6小时
  - JWT认证实现：5小时
  - Redis配置：3小时
  - Alembic迁移：2小时
  - Docker Compose配置：3小时
  - 测试和文档：2小时
- Parallel: false（依赖任务001）

## Definition of Done
- [ ] `docker-compose up` 可启动所有服务
- [ ] 访问 http://localhost:8000/docs 显示完整API文档
- [ ] 数据库8个表创建成功（用pgAdmin或DBeaver验证）
- [ ] JWT登录接口测试通过（返回双token）
- [ ] Redis连接测试正常（ping返回pong）
- [ ] Alembic迁移历史记录完整
- [ ] 代码包含类型注解和docstring
- [ ] 包含项目README（启动步骤、环境变量说明）
