---
id: 12
title: 迁移现有代码到新Flutter项目
status: pending
priority: high
labels: [flutter, migration, code]
assigned:
estimate: 16h
dependencies: [11]
---

# 任务012: 迁移现有代码到新Flutter项目

## 目标
将现有`flutter_app/`项目的所有业务代码迁移到新创建的`flutter_app_new/`项目中，确保功能完整且在双平台上正常运行。

## 背景说明
任务011已创建了包含iOS和Android支持的新Flutter项目。现在需要将旧项目的所有代码迁移过来，包括数据模型、状态管理、UI页面、服务等。

## 详细任务

### 1. 迁移准备 (1h)

**备份旧项目**:
```bash
cp -r flutter_app flutter_app_backup
```

**对比项目结构**:
```bash
# 旧项目结构
tree -L 3 flutter_app/lib

# 新项目结构
tree -L 3 flutter_app_new/lib
```

**创建迁移检查清单**:
- [ ] 数据模型 (7个文件)
- [ ] Provider状态管理 (8个文件)
- [ ] 服务层 (2个文件)
- [ ] 核心配置 (3个文件)
- [ ] UI页面 (估计20+个文件)
- [ ] 路由配置
- [ ] 主题配置
- [ ] 工具类

### 2. 迁移核心配置层 (2h)

**复制并适配核心配置文件**:

```bash
# 复制Dio配置
cp flutter_app/lib/core/config/dio_config.dart flutter_app_new/lib/core/config/

# 复制Hive配置
cp flutter_app/lib/core/config/hive_config.dart flutter_app_new/lib/core/config/

# 复制API常量
cp flutter_app/lib/core/config/api_constants.dart flutter_app_new/lib/core/config/
```

**适配API基础URL**:
```dart
// 确保API地址配置正确
const String baseUrl = 'http://localhost:8000/api';
// 或生产环境
const String baseUrl = 'https://your-domain.com/api';
```

**复制常量和工具**:
```bash
# 复制存储常量
cp flutter_app/lib/core/constants/storage_constants.dart flutter_app_new/lib/core/constants/

# 复制应用常量
cp flutter_app/lib/core/constants/app_constants.dart flutter_app_new/lib/core/constants/

# 复制存储工具
cp flutter_app/lib/core/utils/storage_util.dart flutter_app_new/lib/core/utils/
```

### 3. 迁移数据模型层 (2h)

**复制所有数据模型**:
```bash
cp flutter_app/lib/data/models/*.dart flutter_app_new/lib/data/models/
```

**模型清单** (7个):
- `user.dart` - 用户模型
- `product.dart` - 商品模型
- `category.dart` - 分类模型
- `cart_item.dart` - 购物车项模型
- `order.dart` - 订单模型
- `address.dart` - 地址模型
- `review.dart` - 评价模型

**验证模型导入**:
```dart
// 确保所有模型的import路径正确
import 'package:flutter_app_new/data/models/user.dart';
```

**生成JSON序列化代码**:
```bash
cd flutter_app_new
flutter pub get
flutter pub run build_runner build --delete-conflicting-outputs
```

### 4. 迁移服务层 (1.5h)

**复制服务文件**:
```bash
cp flutter_app/lib/services/api_service.dart flutter_app_new/lib/services/
cp flutter_app/lib/services/mock_service.dart flutter_app_new/lib/services/
```

**适配服务导入路径**:
```dart
// 旧路径
import 'package:flutter_app/data/models/product.dart';

// 新路径
import 'package:flutter_app_new/data/models/product.dart';
```

**测试服务层**:
- API服务初始化
- Mock数据服务
- 网络请求功能

### 5. 迁移状态管理层 (3h)

**复制所有Provider**:
```bash
cp flutter_app/lib/presentation/providers/*.dart flutter_app_new/lib/presentation/providers/
```

**Provider清单** (8个):
- `auth_provider.dart` - 认证状态管理
- `cart_provider.dart` - 购物车状态管理
- `product_provider.dart` - 商品状态管理
- `order_provider.dart` - 订单状态管理
- `theme_provider.dart` - 主题状态管理
- `address_provider.dart` - 地址状态管理
- `favorite_provider.dart` - 收藏状态管理
- `review_provider.dart` - 评价状态管理

**修复Provider依赖**:
```dart
// 确保所有Provider的import路径正确
import 'package:flutter_app_new/data/models/user.dart';
import 'package:flutter_app_new/services/api_service.dart';
import 'package:flutter_app_new/core/utils/storage_util.dart';
```

**适配ChangeNotifier**:
- 确保所有Provider正确继承ChangeNotifier
- 检查dispose()方法实现

### 6. 迁移UI页面层 (4h)

**复制所有页面文件**:
```bash
cp -r flutter_app/lib/presentation/pages/* flutter_app_new/lib/presentation/pages/
cp -r flutter_app/lib/presentation/widgets/* flutter_app_new/lib/presentation/widgets/
```

**页面模块分类**:

**认证相关**:
- `login_page.dart` - 登录页
- `register_page.dart` - 注册页

**商品相关**:
- `home_page.dart` - 首页
- `product_list_page.dart` - 商品列表
- `product_detail_page.dart` - 商品详情
- `search_page.dart` - 搜索页

**购物车和订单**:
- `cart_page.dart` - 购物车
- `checkout_page.dart` - 结算页
- `order_list_page.dart` - 订单列表
- `order_detail_page.dart` - 订单详情

**个人中心**:
- `profile_page.dart` - 个人中心
- `address_list_page.dart` - 地址列表
- `address_edit_page.dart` - 地址编辑
- `favorite_page.dart` - 收藏列表

**评价相关**:
- `review_list_page.dart` - 评价列表
- `review_submit_page.dart` - 提交评价

**修复所有导入路径**:
```dart
// 批量替换导入路径
// 旧: package:flutter_app/
// 新: package:flutter_app_new/

# 使用sed批量替换
find flutter_app_new/lib -name "*.dart" -exec sed -i '' 's/package:flutter_app\//package:flutter_app_new\//g' {} \;
```

**适配Material Design 3**:
```dart
// 确保使用Material 3组件
MaterialApp(
  theme: ThemeData(
    useMaterial3: true,
    // ...
  ),
)
```

### 7. 迁移路由配置 (1h)

**复制路由文件**:
```bash
cp flutter_app/lib/presentation/routes/*.dart flutter_app_new/lib/presentation/routes/
```

**适配路由配置**:
```dart
// 确保所有路由指向新项目的页面
import 'package:flutter_app_new/presentation/pages/home_page.dart';
import 'package:flutter_app_new/presentation/pages/login_page.dart';
// ...
```

**配置main.dart路由**:
```dart
// flutter_app_new/lib/main.dart
import 'package:flutter_app_new/presentation/routes/app_routes.dart';

MaterialApp(
  initialRoute: AppRoutes.splash,
  routes: AppRoutes.routes,
  // ...
)
```

### 8. 迁移主题和样式 (0.5h)

**复制主题配置**:
```bash
cp flutter_app/lib/presentation/providers/theme_provider.dart flutter_app_new/lib/presentation/providers/
```

**适配主题颜色**:
```dart
// 确保主题配置正确
final lightTheme = ThemeData(
  useMaterial3: true,
  colorScheme: ColorScheme.fromSeed(
    seedColor: Colors.orange,
    brightness: Brightness.light,
  ),
);

final darkTheme = ThemeData(
  useMaterial3: true,
  colorScheme: ColorScheme.fromSeed(
    seedColor: Colors.orange,
    brightness: Brightness.dark,
  ),
);
```

### 9. 适配pubspec.yaml资源 (0.5h)

**复制图片资源**:
```bash
cp -r flutter_app/assets/images flutter_app_new/assets/
```

**更新pubspec.yaml**:
```yaml
flutter:
  assets:
    - assets/images/
    - assets/icons/
```

**复制字体资源** (如果有):
```bash
cp -r flutter_app/assets/fonts flutter_app_new/assets/
```

### 10. 编译检查和初步测试 (1.5h)

**清理并重新获取依赖**:
```bash
cd flutter_app_new
flutter clean
flutter pub get
flutter pub run build_runner build --delete-conflicting-outputs
```

**检查编译错误**:
```bash
flutter analyze
```

**修复常见问题**:
- 缺失的导入
- 类型错误
- 命名冲突
- 资源文件路径

**在模拟器上运行**:
```bash
# iOS测试
flutter run -d ios

# Android测试
flutter run -d android
```

**验证基础功能**:
- [ ] App可以启动
- [ ] 登录页面显示
- [ ] 可以导航到首页
- [ ] 网络请求正常

### 11. 功能回归测试 (建议在任务013中进行)

这里只是初步验证，完整测试在任务013进行。

## 验收标准

### 必须满足
- [ ] ✅ 所有数据模型已迁移并正确导入
- [ ] ✅ 所有Provider已迁移并功能正常
- [ ] ✅ 所有UI页面已迁移并可访问
- [ ] ✅ 路由配置正确，页面导航正常
- [ ] ✅ 服务层功能正常（API/Mock）
- [ ] ✅ 主题和样式正确应用
- [ ] ✅ 无编译错误
- [ ] ✅ App可以在iOS和Android上启动

### 质量标准
- [ ] 所有导入路径正确（使用flutter_app_new）
- [ ] 代码格式化通过（`flutter format .`）
- [ ] 静态分析无错误（`flutter analyze`）
- [ ] 基础功能可用（登录、浏览、导航）

## 迁移检查清单

### 数据层 (7个文件)
- [ ] user.dart
- [ ] product.dart
- [ ] category.dart
- [ ] cart_item.dart
- [ ] order.dart
- [ ] address.dart
- [ ] review.dart

### 状态管理 (8个文件)
- [ ] auth_provider.dart
- [ ] cart_provider.dart
- [ ] product_provider.dart
- [ ] order_provider.dart
- [ ] theme_provider.dart
- [ ] address_provider.dart
- [ ] favorite_provider.dart
- [ ] review_provider.dart

### 服务层 (2个文件)
- [ ] api_service.dart
- [ ] mock_service.dart

### 核心配置 (3个文件)
- [ ] dio_config.dart
- [ ] hive_config.dart
- [ ] api_constants.dart

### UI页面 (估计20+个文件)
- [ ] 认证页面 (登录/注册)
- [ ] 商品页面 (首页/列表/详情/搜索)
- [ ] 购物车页面 (购物车/结算)
- [ ] 订单页面 (列表/详情)
- [ ] 个人中心 (个人/地址/收藏)
- [ ] 评价页面 (列表/提交)

### 其他
- [ ] 路由配置
- [ ] 主题配置
- [ ] 工具类
- [ ] 资源文件 (图片/字体)

## 工作目录
```
/Volumes/545S/general final/flutter_app_new
```

## 依赖关系
- 依赖任务011（新Flutter项目创建）
- 需要旧项目代码来源：`/Volumes/545S/general final/flutter_app`

## 注意事项
1. 新项目名：flutter_app_new
2. 包名：com.restaurant.deliveryapp
3. 所有import路径从`flutter_app`改为`flutter_app_new`
4. 保留旧项目作为备份
5. 使用批量替换工具提高效率
6. 分模块迁移，每完成一个模块就测试
7. iOS和Android配置已在任务011完成，此任务专注代码迁移

## 常见问题解决

### 问题1: JSON序列化代码生成失败
**解决**:
```bash
flutter pub run build_runner build --delete-conflicting-outputs
```

### 问题2: 资源文件找不到
**解决**: 检查pubspec.yaml的assets配置，确保路径正确

### 问题3: iOS权限配置缺失
**解决**: 任务011已配置，如有问题检查ios/Runner/Info.plist

### 问题4: Android权限配置缺失
**解决**: 任务011已配置，如有问题检查android/app/src/main/AndroidManifest.xml

## 下一步
完成代码迁移后，继续任务013（双平台测试和验证）

## 参考资源
- [Flutter代码迁移指南](https://docs.flutter.dev/development/tools/devtools/code-dropping)
- [Material Design 3](https://m3.material.io/)
- [Flutter包迁移](https://docs.flutter.dev/cookbook/networking/fetch-data)
